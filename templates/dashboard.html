<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Breeder Dashboard - Knowledge Graph</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        .header h1 {
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .card h2 {
            color: #2c3e50;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .search-section {
            grid-column: 1 / -1;
            text-align: center;
        }
        
        .search-box {
            display: flex;
            gap: 1rem;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .search-box input, .search-box select, .search-box button {
            padding: 0.75rem 1rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .search-box button {
            background: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .search-box button:hover {
            background: #2980b9;
        }
        
        .network-container {
            height: 400px;
            border: 2px solid #eee;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }
        
        .results-container {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .result-item {
            padding: 0.75rem;
            border-bottom: 1px solid #eee;
            transition: background 0.3s;
        }
        
        .result-item:hover {
            background: #f8f9fa;
        }
        
        .score {
            background: #e74c3c;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .score.high { background: #27ae60; }
        .score.medium { background: #f39c12; }
        .score.low { background: #e74c3c; }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
        
        .error {
            background: #fee;
            color: #c33;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .success {
            background: #efe;
            color: #363;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .stat-item {
            text-align: center;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #3498db;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .node {
            stroke: #fff;
            stroke-width: 2px;
            cursor: pointer;
        }
        
        .node.gene { fill: #3498db; }
        .node.trait { fill: #e74c3c; }
        .node.qtl { fill: #f39c12; }
        
        .link {
            stroke: #999;
            stroke-opacity: 0.6;
            stroke-width: 2px;
        }
        
        .node-label {
            font-size: 12px;
            font-weight: bold;
            text-anchor: middle;
            pointer-events: none;
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .search-box {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üß¨ Breeder Dashboard - Knowledge Graph System</h1>
    </div>
    
    <div class="container">
        <!-- Search Section -->
        <div class="card search-section">
            <h2>üîç Search & Explore</h2>
            <div class="search-box">
                <input type="text" id="searchQuery" placeholder="Search genes, traits, or germplasm..." />
                <select id="searchType">
                    <option value="all">All Types</option>
                    <option value="gene">Genes</option>
                    <option value="trait">Traits</option>
                    <option value="germplasm">Germplasm</option>
                </select>
                <button onclick="performSearch()">Search</button>
                <button onclick="loadNetwork()">Load Network</button>
            </div>
            <div id="searchResults"></div>
        </div>
        
        <div class="dashboard-grid">
            <!-- Gene-Trait Network -->
            <div class="card">
                <h2>üï∏Ô∏è Gene-Trait Network</h2>
                <div class="network-container" id="networkViz">
                    <div class="loading">
                        <p>Click "Load Network" to visualize gene-trait relationships</p>
                        <p style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">
                            Note: Requires Neo4j database connection
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Candidate Genes -->
            <div class="card">
                <h2>üéØ Candidate Genes</h2>
                <div>
                    <input type="text" id="traitInput" placeholder="Enter trait name (e.g., drought_tolerance)" style="width: 100%; padding: 0.5rem; margin-bottom: 1rem; border: 1px solid #ddd; border-radius: 4px;" />
                    <button onclick="getCandidateGenes()" style="width: 100%; padding: 0.75rem; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer;">Get Candidate Genes</button>
                </div>
                <div class="results-container" id="candidateResults">
                    <div class="loading">Enter a trait name and click "Get Candidate Genes"</div>
                </div>
            </div>
            
            <!-- Germplasm Performance -->
            <div class="card">
                <h2>üìä Germplasm Performance</h2>
                <div>
                    <input type="text" id="performanceTraitInput" placeholder="Enter trait name" style="width: 70%; padding: 0.5rem; margin-bottom: 1rem; border: 1px solid #ddd; border-radius: 4px;" />
                    <button onclick="getGermplasmPerformance()" style="width: 25%; padding: 0.5rem; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 5%;">Analyze</button>
                </div>
                <div class="results-container" id="performanceResults">
                    <div class="loading">Enter a trait name to analyze germplasm performance</div>
                </div>
            </div>
            
            <!-- System Status -->
            <div class="card">
                <h2>‚ö° System Status</h2>
                <div id="systemStatus">
                    <div class="loading">Loading system status...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let networkData = null;
        let svg = null;
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            checkSystemStatus();
            setupNetworkVisualization();
        });
        
        // Search functionality
        async function performSearch() {
            const query = document.getElementById('searchQuery').value;
            const type = document.getElementById('searchType').value;
            const resultsDiv = document.getElementById('searchResults');
            
            if (!query.trim()) {
                resultsDiv.innerHTML = '<div class="error">Please enter a search query</div>';
                return;
            }
            
            resultsDiv.innerHTML = '<div class="loading">Searching...</div>';
            
            try {
                const response = await axios.get(`/api/search?q=${encodeURIComponent(query)}&type=${type}`);
                
                if (response.data.status === 'success') {
                    displaySearchResults(response.data.results);
                } else {
                    resultsDiv.innerHTML = `<div class="error">Search failed: ${response.data.error}</div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">Search error: ${error.message}</div>`;
            }
        }
        
        function displaySearchResults(results) {
            const resultsDiv = document.getElementById('searchResults');
            
            if (results.length === 0) {
                resultsDiv.innerHTML = '<div class="loading">No results found</div>';
                return;
            }
            
            let html = '<div class="results-container"><h3>Search Results:</h3>';
            results.forEach(result => {
                html += `
                    <div class="result-item">
                        <strong>${result.name || result.symbol}</strong> 
                        <span class="score ${result.type}">${result.type}</span>
                        <br>
                        <small>${result.description || 'No description available'}</small>
                    </div>
                `;
            });
            html += '</div>';
            
            resultsDiv.innerHTML = html;
        }
        
        // Network visualization
        function setupNetworkVisualization() {
            const container = document.getElementById('networkViz');
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            svg = d3.select('#networkViz')
                .append('svg')
                .attr('width', width)
                .attr('height', height);
        }
        
        async function loadNetwork() {
            const networkDiv = document.getElementById('networkViz');
            networkDiv.innerHTML = '<div class="loading">Loading network data...</div>';
            
            try {
                const response = await axios.get('/api/network?max_nodes=50');
                
                if (response.data.status === 'success') {
                    networkData = response.data;
                    visualizeNetwork(networkData);
                } else {
                    networkDiv.innerHTML = `<div class="error">Failed to load network: ${response.data.error}</div>`;
                }
            } catch (error) {
                networkDiv.innerHTML = `<div class="error">Network error: ${error.message}<br><small>Make sure Neo4j is running and contains data</small></div>`;
            }
        }
        
        function visualizeNetwork(data) {
            const container = document.getElementById('networkViz');
            container.innerHTML = '';
            
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            svg = d3.select('#networkViz')
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            // Create force simulation
            const simulation = d3.forceSimulation(data.nodes)
                .force('link', d3.forceLink(data.edges).id(d => d.id).distance(100))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2));
            
            // Create links
            const link = svg.append('g')
                .selectAll('line')
                .data(data.edges)
                .enter().append('line')
                .attr('class', 'link')
                .attr('stroke-width', d => Math.sqrt(d.weight || 1) * 2);
            
            // Create nodes
            const node = svg.append('g')
                .selectAll('circle')
                .data(data.nodes)
                .enter().append('circle')
                .attr('class', d => `node ${d.type}`)
                .attr('r', 8)
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));
            
            // Add labels
            const label = svg.append('g')
                .selectAll('text')
                .data(data.nodes)
                .enter().append('text')
                .attr('class', 'node-label')
                .text(d => d.label)
                .attr('dy', -12);
            
            // Add tooltips
            node.append('title')
                .text(d => `${d.label} (${d.type})`);
            
            // Update positions on simulation tick
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);
                
                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);
                
                label
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            });
            
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }
            
            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }
            
            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
        }
        
        // Candidate genes
        async function getCandidateGenes() {
            const traitName = document.getElementById('traitInput').value;
            const resultsDiv = document.getElementById('candidateResults');
            
            if (!traitName.trim()) {
                resultsDiv.innerHTML = '<div class="error">Please enter a trait name</div>';
                return;
            }
            
            resultsDiv.innerHTML = '<div class="loading">Finding candidate genes...</div>';
            
            try {
                const response = await axios.get(`/api/candidates?trait_name=${encodeURIComponent(traitName)}&top_k=10`);
                
                if (response.data.status === 'success') {
                    displayCandidateGenes(response.data.candidates);
                } else {
                    resultsDiv.innerHTML = `<div class="error">Failed to get candidates: ${response.data.error}</div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }
        
        function displayCandidateGenes(candidates) {
            const resultsDiv = document.getElementById('candidateResults');
            
            if (candidates.length === 0) {
                resultsDiv.innerHTML = '<div class="loading">No candidate genes found for this trait</div>';
                return;
            }
            
            let html = '';
            candidates.forEach((candidate, index) => {
                const scoreClass = candidate.prediction_score > 0.7 ? 'high' : 
                                 candidate.prediction_score > 0.4 ? 'medium' : 'low';
                
                html += `
                    <div class="result-item">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong>${candidate.gene_name}</strong>
                            <span class="score ${scoreClass}">${(candidate.prediction_score * 100).toFixed(1)}%</span>
                        </div>
                        <div style="font-size: 0.9rem; color: #666; margin-top: 0.25rem;">
                            ${candidate.chromosome ? `Chr: ${candidate.chromosome}` : ''} 
                            ${candidate.position ? `Pos: ${candidate.position}` : ''}
                        </div>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }
        
        // Germplasm performance
        async function getGermplasmPerformance() {
            const traitName = document.getElementById('performanceTraitInput').value;
            const resultsDiv = document.getElementById('performanceResults');
            
            if (!traitName.trim()) {
                resultsDiv.innerHTML = '<div class="error">Please enter a trait name</div>';
                return;
            }
            
            resultsDiv.innerHTML = '<div class="loading">Analyzing germplasm performance...</div>';
            
            try {
                const response = await axios.get(`/api/performance?trait_name=${encodeURIComponent(traitName)}`);
                
                if (response.data.status === 'success') {
                    displayGermplasmPerformance(response.data.performance);
                } else {
                    resultsDiv.innerHTML = `<div class="error">Failed to get performance data: ${response.data.error}</div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }
        
        function displayGermplasmPerformance(performance) {
            const resultsDiv = document.getElementById('performanceResults');
            
            if (performance.length === 0) {
                resultsDiv.innerHTML = '<div class="loading">No performance data found for this trait</div>';
                return;
            }
            
            let html = '';
            performance.forEach(perf => {
                html += `
                    <div class="result-item">
                        <strong>${perf.germplasm}</strong>
                        <div style="display: flex; justify-content: space-between; margin-top: 0.25rem;">
                            <span>Avg: ${perf.avg_value ? perf.avg_value.toFixed(2) : 'N/A'}</span>
                            <span>N: ${perf.num_measurements}</span>
                        </div>
                        <div style="font-size: 0.8rem; color: #666;">
                            ${perf.location} (${perf.year})
                        </div>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }
        
        // System status
        async function checkSystemStatus() {
            const statusDiv = document.getElementById('systemStatus');
            
            try {
                // Check if API is responding
                const response = await axios.get('/api/search?q=test&type=all');
                
                statusDiv.innerHTML = `
                    <div class="success">‚úÖ Dashboard API: Online</div>
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-value">üåê</div>
                            <div class="stat-label">Web Interface</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">üì°</div>
                            <div class="stat-label">API Ready</div>
                        </div>
                    </div>
                    <p style="font-size: 0.9rem; color: #666; margin-top: 1rem;">
                        Note: Neo4j database connection required for full functionality
                    </p>
                `;
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="error">‚ùå API Connection Failed</div>
                    <p style="font-size: 0.9rem; margin-top: 0.5rem;">
                        Error: ${error.message}
                    </p>
                `;
            }
        }
        
        // Enter key support for search
        document.getElementById('searchQuery').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
        
        document.getElementById('traitInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                getCandidateGenes();
            }
        });
        
        document.getElementById('performanceTraitInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                getGermplasmPerformance();
            }
        });
    </script>
</body>
</html>
